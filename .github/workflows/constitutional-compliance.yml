name: Constitutional Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  constitutional-compliance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check bundle sizes
      id: bundle-check
      run: |
        npm run build

        # Check total bundle size
        TOTAL_SIZE=$(find .next/static/chunks -name "*.js" -exec du -b {} + | awk '{sum += $1} END {print sum}')
        TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
        echo "Total bundle size: ${TOTAL_SIZE_MB}MB"
        echo "total_size_mb=${TOTAL_SIZE_MB}" >> $GITHUB_OUTPUT

        # Check if exceeding 2MB limit
        if (( $(echo "$TOTAL_SIZE_MB > 2" | bc -l) )); then
          echo "::error::Bundle size ${TOTAL_SIZE_MB}MB exceeds 2MB limit"
          exit 1
        fi

    - name: Check individual tool sizes
      run: |
        # Check individual tool bundle sizes (this would need actual tool-specific analysis)
        echo "Checking individual tool bundle sizes..."

        # Example: Find tool-specific bundles and check 200KB limit
        find .next/static/chunks -name "*tool*" -type f | while read file; do
          SIZE=$(du -b "$file" | cut -f1)
          SIZE_KB=$((SIZE / 1024))

          if [ $SIZE_KB -gt 200 ]; then
            echo "::error::Tool bundle $file is ${SIZE_KB}KB, exceeds 200KB limit"
            exit 1
          fi
        done

    - name: Verify client-side processing
      run: |
        # Check that no server-side API routes exist for tool functionality
        if [ -d "src/pages/api" ]; then
          echo "::warning::API routes found - ensure tools use client-side processing"

          # Check for tool-specific API routes
          find src/pages/api -name "*" -type f | while read file; do
            if grep -q "crypto\|exec\|eval\|spawn" "$file"; then
              echo "::error::Server-side processing detected in $file"
              exit 1
            fi
          done
        fi

    - name: Check Monaco Editor integration
      run: |
        # Verify Monaco Editor is used for code/data input tools
        if ! grep -r "monaco-editor\|@monaco-editor" src/components/tools/ 2>/dev/null; then
          echo "::warning::Monaco Editor integration not detected in tools"
        fi

    - name: Verify tool modularity
      run: |
        # Check that tools are structured as standalone components
        if [ ! -d "src/components/tools" ]; then
          echo "::error::Tools directory not found"
          exit 1
        fi

        # Check for tool isolation
        find src/components/tools -name "*.tsx" | while read file; do
          # Each tool should be self-contained
          if ! grep -q "export default" "$file"; then
            echo "::warning::Tool $file may not be properly modularized"
          fi
        done

    - name: Check progressive enhancement
      run: |
        # Verify accessibility features
        if ! grep -r "aria-\|role=\|tabIndex" src/components/tools/ 2>/dev/null; then
          echo "::warning::Limited accessibility features detected"
        fi

        # Check for keyboard navigation support
        if ! grep -r "onKeyDown\|onKeyUp\|onFocus" src/components/tools/ 2>/dev/null; then
          echo "::warning::Limited keyboard navigation support"
        fi

    - name: Performance compliance check
      run: |
        # Run Lighthouse CI for performance validation
        npm install -g @lhci/cli@0.12.x

        # Create Lighthouse config
        cat > lighthouserc.js << EOF
        module.exports = {
          ci: {
            collect: {
              url: ['http://localhost:3000'],
              numberOfRuns: 3
            },
            assert: {
              assertions: {
                'categories:performance': ['warn', { minScore: 0.8 }],
                'categories:accessibility': ['error', { minScore: 0.9 }],
                'categories:best-practices': ['warn', { minScore: 0.8 }],
                'categories:seo': ['warn', { minScore: 0.8 }]
              }
            },
            upload: {
              target: 'temporary-public-storage'
            }
          }
        };
        EOF

        # Start the application
        npm run dev &
        APP_PID=$!
        sleep 30

        # Run Lighthouse
        lhci autorun
        LHCI_EXIT_CODE=$?

        # Stop the application
        kill $APP_PID

        if [ $LHCI_EXIT_CODE -ne 0 ]; then
          echo "::error::Lighthouse performance checks failed"
          exit 1
        fi

    - name: Type safety compliance
      run: |
        # Check TypeScript compilation
        npm run type-check

        # Check for any TypeScript errors
        if [ $? -ne 0 ]; then
          echo "::error::TypeScript compilation failed"
          exit 1
        fi

    - name: Test coverage compliance
      run: |
        # Run tests with coverage
        npm run test:coverage

        # Check minimum coverage (80%)
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct' 2>/dev/null || echo "0")

        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "::warning::Test coverage ${COVERAGE}% is below 80%"
        fi

    - name: Security compliance
      run: |
        # Check for security vulnerabilities
        npm audit --audit-level moderate

        if [ $? -ne 0 ]; then
          echo "::warning::Security vulnerabilities detected"
        fi

        # Check for unsafe code patterns
        grep -r "eval\|Function(\|innerHTML\|outerHTML" src/ --exclude-dir=node_modules | while read line; do
          echo "::warning::Potentially unsafe code pattern: $line"
        done

    - name: Bundle analysis
      if: always()
      run: |
        echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Total bundle size: ${{ steps.bundle-check.outputs.total_size_mb }}MB" >> $GITHUB_STEP_SUMMARY

        # Add detailed analysis
        echo "### Tool Bundle Sizes" >> $GITHUB_STEP_SUMMARY
        find .next/static/chunks -name "*tool*" -type f -exec du -h {} + | sort -hr | while read line; do
          echo "- $line" >> $GITHUB_STEP_SUMMARY
        done

    - name: Generate compliance report
      if: always()
      run: |
        echo "# Constitutional Compliance Report" > compliance-report.md
        echo "" >> compliance-report.md
        echo "## Build Information" >> compliance-report.md
        echo "- **Date**: $(date)" >> compliance-report.md
        echo "- **Commit**: ${{ github.sha }}" >> compliance-report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> compliance-report.md
        echo "" >> compliance-report.md
        echo "## Bundle Sizes" >> compliance-report.md
        echo "- **Total Bundle Size**: ${{ steps.bundle-check.outputs.total_size_mb }}MB" >> compliance-report.md
        echo "- **Status**: $([ ${{ steps.bundle-check.outputs.total_size_mb }} > 2 ] && echo "❌ Exceeds 2MB limit" || echo "✅ Within limit")" >> compliance-report.md
        echo "" >> compliance-report.md
        echo "## Compliance Checks" >> compliance-report.md
        echo "- ✅ Bundle size analysis" >> compliance-report.md
        echo "- ✅ Client-side processing verification" >> compliance-report.md
        echo "- ✅ Monaco Editor integration check" >> compliance-report.md
        echo "- ✅ Tool modularity verification" >> compliance-report.md
        echo "- ✅ Progressive enhancement check" >> compliance-report.md
        echo "- ✅ Performance validation" >> compliance-report.md
        echo "- ✅ Type safety compliance" >> compliance-report.md
        echo "- ✅ Test coverage validation" >> compliance-report.md
        echo "- ✅ Security compliance check" >> compliance-report.md

        # Upload compliance report
        echo "compliance_report_path=<<EOF" >> $GITHUB_OUTPUT
        cat compliance-report.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Upload compliance artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.md
